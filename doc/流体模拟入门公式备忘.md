## NS方程——质量守恒方程



## NS方程的求解

$\frac{\partial \vec{u}}{\partial t}+\vec{u} \cdot \nabla \vec{u}=-\frac{1}{\rho}\nabla p+v \nabla ^2\vec{u}+\vec{g}$

$\nabla \cdot \vec{u}=0$



## NS方程的分步求解——离散化

$(\frac{\partial q}{\partial x})_i\approx \frac{q_{i+1}-q_{i-1}}{2\Delta x}$

$(\frac{\partial q}{\partial x})_i\approx \frac{q_{i+1/2}-q_{i-1/2}}{\Delta x}$

$\vec{u}_{i,j}=(\frac{u_{i-1/2,j}+u_{i+1/2,j}}{2},\frac{v_{i,j-1/2}+v_{i,j+1/2}}{2})$

$\vec{u}_{i+1/2,j}=(u_{i+1/2,j},\frac{v_{i,j-1/2}+v_{i,j+1/2}+v_{i+1,j-1/2}+v_{i+1,j+1/2}}{4})$

$\vec{u}_{i,j+1/2}=(\frac{u_{i-1/2,j}+u_{i+1/2,j}+u_{i-1/2,j+1}+u_{i+1/2,j+1}}{4},v_{i,j+1/2})$



##NS方程的分步求解——分步求解思想

$\frac{\partial \vec{u}}{\partial t}=-\vec{u} \cdot \nabla \vec{u}-\frac{1}{\rho}\nabla p+v \nabla ^2\vec{u}+\vec{g}$

$\frac{dq}{dt}=f(q)+g(q)$

$q^{n+1}=q^n+\Delta t(f(q^n)+g(q^n))$

$q^*= q^n + \Delta t f(q^n)$

$q^{n+1}= q^* + \Delta t g(q^*)$

$q^{n+1}=(q^n+\Delta tf(q^n))+\Delta g(q^n+\Delta t f(q^n))\\=q^n+\Delta t f(q^n)+\Delta t(g(q^n)+O(\Delta t))\\=q^n+\Delta t(f(q^n)+g(q^n))+O(\Delta t ^2)\\= q^n+\frac{dq}{dt}\Delta t+O(\Delta t ^2)$

##NS方程的分步求解——分步求解

$\frac{\partial \vec{u}}{\partial t}+\vec{u} \cdot \nabla \vec{u}=-\frac{1}{\rho}\nabla p+v \nabla ^2\vec{u}+\vec{g}$

$\nabla \cdot \vec{u}=0$

$\frac{Dq}{Dt}=\frac{\partial q}{\partial t}+\vec{u}\cdot q = 0$

$\frac{\partial \vec{u}}{\partial t}=\vec{g}$

$\begin {cases}\frac{\partial \vec{u}}{\partial t}+\frac{1}{\rho}\nabla p = 0 \\ \nabla \cdot \vec{u}=0 \end {cases}$

$\Delta t = t_{n+1}-t_n$

$\vec{u}_A = advect(\vec{u}_n, \Delta t, \vec{q})$

$\vec {u}_B = \vec{u}_A + \Delta t \vec{g}$

$\vec{u}_{n+1}=project(\Delta t, \vec{u}_B)$

## NS方程的分步求解——对流

$q_G^{n+1}$

$q_P^{n}$

$\frac{d\vec{x}}{dt}=\vec{u}(\vec{x})$

$\frac{\vec{x}_G-\vec{x}_P}{\Delta t}=\vec{u}(\vec {x}_G)$

$\vec{x}_P=\vec{x}_G-\Delta t \vec{u}(\vec{x}_G)$

## NS方程的分步求解——压力/不可压缩投影

$\frac{\partial \vec{u}}{\partial t}+\frac{1}{\rho}\nabla p = 0 $

$\nabla \cdot \vec{u}=0$

$\nabla p = (\frac {p_{i+1,j}-p_{i,j}}{\Delta x},\frac {p_{i,j+1}-p_{i,j}}{\Delta x})$

$\nabla \cdot \vec{u}=\frac{\partial u}{\partial x}+\frac{\partial v}{\partial y} \approx \frac{u_{i+1/2,j}-u_{i-1/2,j}}{\Delta x}+\frac{v_{i+1/2,j}-v_{i-1/2,j}}{\Delta x} =0$

$\frac{u_{i+1/2,j}^{n+1}-u_{i-1/2,j}^{n+1}}{\Delta x}+\frac{v_{i+1/2,j}^{n+1}-v_{i-1/2,j}^{n+1}}{\Delta x} =0$

$u_{i+1/2,j}^{n+1}=u_{i+1/2,j}-\Delta t \frac{1}{\rho}\frac{p_{i+1,j}-p_{i,j}}{\Delta x}$

$u_{i-1/2,j}^{n+1}=u_{i-1/2,j}-\Delta t \frac{1}{\rho}\frac{p_{i-1,j}-p_{i,j}}{\Delta x}$

$v_{i,j+1/2}^{n+1}=v_{i,j+1/2}-\Delta t \frac{1}{\rho}\frac{p_{i,j+1}-p_{i,j}}{\Delta x}$

$v_{i,j-1/2}^{n+1}=v_{i,j-1/2}-\Delta t \frac{1}{\rho}\frac{p_{i,j-1}-p_{i,j}}{\Delta x}$

$\frac{\Delta t}{\rho}(\frac{4p_{i,j}-p_{i+1,j}-p_{i,j+1}-p_{i-1,j}-p_{i,j-1}}{\Delta x ^2})=-(\frac {u_{i+1/2, j}-u_{i-1/2,j}}{\Delta x},\frac {v_{i+1/2, j}-v_{i-1/2,j}}{\Delta x})$

泊松方程 $-\frac{\Delta t}{\rho}\nabla \cdot \nabla p = -\nabla \cdot \vec{u}$
$$
\begin {bmatrix} 
a_{0,0} & \cdots & a_{0,m*n}\\ 
\vdots & \ddots & \vdots \\
a_{m*n,0} & \cdots & a_{m*n,m*n}
\end {bmatrix}

\begin {bmatrix}
p_{0,0} \\ \vdots \\ p_{m,n}
\end {bmatrix}
=
\begin {bmatrix}
\nabla \cdot \vec{u}_{0,0} \\ \vdots \\ \nabla \cdot \vec{u}_{m,n}
\end {bmatrix}
$$

$$
\begin{pmatrix} 1 & a_1 & a_1^2 & \cdots & a_1^n \\ 1 & a_2 & a_2^2 & \cdots & a_2^n \\ \vdots & \vdots& \vdots & \ddots & \vdots \\ 1 & a_m & a_m^2 & \cdots & a_m^n \end{pmatrix}
$$


$O(m^2n^2)$

## NS方程的求解

$\frac{Dq}{Dt}=\frac{\partial q}{\partial t}+\vec{u}\cdot q = 0$

$\frac{\partial \vec{u}}{\partial t}=\vec{g}$

$\begin {cases}\frac{\partial \vec{u}}{\partial t}+\frac{1}{\rho}\nabla p = 0 \\ \nabla \cdot \vec{u}=0 \end {cases}$



## SPH

$V_i = \frac{m_i}{\rho_i}$



$A_i = \Sigma _j \frac{m_j}{\rho_j}W(\vec{x}_i-\vec{x}_j, h)$

简化写法$A_i = \Sigma _j \frac{m_j}{\rho_j}W_{ij}$

$\nabla A_i = \Sigma _j \frac{m_j}{\rho_j}\nabla W_{ij}$

$\nabla ^2 A_i = \Sigma _j \frac{m_j}{\rho_j}\nabla ^2 W_{ij}$



$\frac{\partial \vec{u}}{\partial t}+\vec{u} \cdot \nabla \vec{u}=-\frac{1}{\rho}\nabla p+v \nabla ^2\vec{u}+\vec{g}$

$\nabla \cdot \vec{u}=0$

$\vec{a} = \frac{\vec{F}}{m}$

两边同时乘以$\rho$

$\rho \frac{\partial \vec{u}}{\partial t}=-\nabla p+\mu \nabla ^2\vec{u}+\rho\vec{g}$



## SPH——密度

$A_i=\Sigma_j \frac{m_j}{\rho_j}A_jW_{ij}$

$\rho_i = \Sigma _j \frac{m_j}{\rho_j}\rho_j W_{ij}$

$\rho_i = \Sigma _j m_j W_{ij}$



## SPH——压力

$p_i = k(\rho_i-\rho_0)$

$p_i = max(k(\rho_i-\rho_0),0)$

$\nabla A_i = \Sigma _j \frac{m_j}{\rho_j}A_j \nabla W_{ij}$

$\vec{f}_i^{pressure}=-\Sigma _j \frac{m_j}{\rho_j}p_j\nabla W_{ij}$

$\vec{f}_i^{pressure}=- \Sigma _j \frac{m_j}{\rho_j}\frac{p_i+p_j}{2}\nabla W_{ij}$

$\vec{f}_1^{pressure}=-\frac{m_2}{\rho_2}p_2\nabla W_{12}$

$\vec{f}_2^{pressure}=-\frac{m_1}{\rho_1}p_1\nabla W_{21}$

$\vec{F}=\vec{f}V$

$\vec{F}_1^{pressure}=-\frac{m_1}{\rho_1}\frac{m_2}{\rho_2}p_2\nabla W_{12}$

$\vec{F}_2^{pressure}=-\frac{m_2}{\rho_2}\frac{m_1}{\rho_1}p_1\nabla W_{21}$

$\vec{F}_1^{pressure}=\vec{F}_2^{pressure}$

## SPH——黏力

$\vec{f}_i^{viscosity}=\mu \Sigma _j \frac{m_j}{\rho_j}\vec{u}_j\nabla ^2 W_{ij}$

$\vec{f}_i^{viscosity}=\mu \Sigma _j \frac{m_j}{\rho_j}(\vec{u}_j-\vec{u}_i)\nabla ^2 W_{ij}$

## SPH——体积力

$\vec{f}_i^{gravity}=\rho_i \vec{g}$

## SPH——速度和位移

合力/V：$\vec{f}_i = \vec{f}_i^{pressure}+\vec{f}_i^{viscosity}+\vec{f}_i^{gravity}$

加速度：$\vec{a}=\frac{\vec{f}_i}{\rho _i}$

速度：$\vec{u}_i(t+1)=\vec{u}_i(t)+\Delta t \frac{\vec{f}_i}{\rho_i}$

位置：$\vec{x}_i(t+1)=\vec{x}_i(t)+\Delta t \vec{u}_i(t+1)$

## SPH——算法

$\rho_i=\Sigma _j m_j W_{ij}$

$p_i = k(\rho_i-\rho_0)$

$\vec{f}_i^{pressure}=-\Sigma _j \frac{m_j}{\rho_j}\frac{p_i+p_j}{2} \nabla W_{ij}$

$\vec{f}_i^{viscosity}=\mu \Sigma _j \frac{m_j}{\rho_j}(\vec{u}_j-\vec{u}_i)\nabla ^2 W_{ij}$

$\vec{f}_i^{gravity}=\rho_i \vec{g}$

$\vec{u}_i(t+1)=\vec{u}_i(t)+\Delta t \frac{\vec{f}_i}{\rho_i}$

$\vec{x}_i(t+1)=\vec{x}_i(t)+\Delta t \vec{u}_i(t+1)$



## SPH——核函数的选取

$W_{poly6}(r,h)=\frac{315}{64\pi h^9}\begin {cases} f \\ f \end {cases}$







## SPH——修正密度计算

边界粒子$b_i$的体积：$V_{b_i}=\frac{m_{b_i}}{\rho_{b_i}}=\frac{m_{b_i}}{\Sigma_k m_{b_k}W_{ik}}$

流体粒子$f_i$的密度：$\rho_{f_i}=m_{f_i}\Sigma_jW_{ij}+m_{f_i}\Sigma_kW_{ik}$

边界粒子体积大小对液体密度的影响：$\Psi_{b_i}(\rho_0)=\rho_0V_{b_i}$

修正后的流体密度：$\rho_{f_i}=m_{f_i}\Sigma_jW_{ij}+m_{f_i}\sigma_k\Psi_{b_k}(\rho_0)W_{ik}$

两个液体粒子之间的压力：$\vec{F}_{i \leftarrow j}^P=-m_i m_j(\frac{p_j}{\rho_i \rho_j})\nabla W_ij = -m_i m_j(\frac{p_x}{\rho_x^2})\nabla W_{ij}$

边界粒子$b_j$对流体粒子$f_i$的压力：$\vec{F}_{f_i \leftarrow b_j}^P=-m_{f_i}\Psi_{b_j} (\rho _0)(\frac{p_{f_i}}{\rho_{f_i}^2})\nabla W_{ij}$

液体粒子$f_i$对边界粒子$b_j$的压力：$\vec{F}_{f_i \leftarrow b_j}^P=-\vec{F}_{b_j \leftarrow f_i}^P$



