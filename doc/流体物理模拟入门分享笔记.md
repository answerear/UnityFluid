# 流体模拟入门分享



---

## 认识流体

在做流体模拟之前，我们首先需要对流体有一个简单的初步认识。那么，什么是流体呢？

流体是液体和气体的统称，指那些**易于流动的物质**，是区别于固体的物质。但这个定义不太明确，什么样才是**易于流动**呢？

所以，要正确理解流体和固体的区别，首先要理解**什么是流动**，流动是指**不断变形的运动**，这里变形指的是**物体的形状发生了变化**。

水装在矿泉水瓶里的时候，我们是不能判断它是液体还是固体的，当我们想把水倒出来的时候，能流出来的是水，流不出来的是冰。也就是说，判断一种物质是不是流体，不是从它的成分判断的，而是根据它**受力时的运动状态**。

固体可以放在桌子上保持静止，而流体就必须装在容器中才行。原因是只有装在容器中，才能使流体不受**剪切力**作用。流体的内部只要存在剪切力，就不可能处于静止状态，而是会**不断地发生角变形运动**，也就是流动。

所以，我们可以给流体下一个严格的定义：**在任意小的剪切力作用下，都会发生连续不断的角变形的物质**。

---

## 观察流体

在对流体有了初步的认识之后，我们就可以对流体运动进行观察和研究了。

在对流体进行研究时，通常有两种视角：拉格朗日视角和欧拉视角。

其中拉格朗日视角将流体视为流动的单元，例如将一片羽毛放入风中，那么羽毛的轨迹可以帮我们指示空气的流动规律；而欧拉视角则是坐标系固定，如同站在河边观察河水的流动一样；

左边展示的是基于拉格朗日视角的模拟，也是我们前面开场动画里的展示的基于位置的动力学的模拟，可以看到，它其实就是采用各种各样的粒子，然后通过各种方式给物体连接起来；然后这个粒子可以表示降落伞的绳子，这个降落伞下面栓的是个兔子，我们不仅可以用这个粒子来模拟水，还可以用它来模拟各种各样的东西；

而右边则是一个典型的欧拉表示的烟雾模拟，其实这个里面其实就是一般是用一个背景的网格，然后网格上的每一个点表示的是穿过这个点的流体的速度。

那左边这个基于粒子的模拟呢，它的每一个粒子表示的是这个粒子它会携带什么？一般会携带它自己的速度和位置。

所以一个常见的问题就是，欧拉的网格里面的每个点，我们是不记它的位置的，因为它的位置很容易算出来，对吧？因为你可以通过它的 i，j，k下标，然后乘上一个 delta x，你就知道这个网格的格点的位置是在什么地方，但是拉格朗日粒子里面，我们会在粒子上面额外的记一个位置，因为这个粒子的位置会随着被模拟的介质的状态被不断地移动。

总的来说，这两个视角只是从不同观点出发，研究同一个运动。



---

## 大名鼎鼎的NS方程

NS方程也就是纳维-斯托克斯方程，可以说是流体力学的“白月光”。它在流体力学界的地位相当于经典力学中的牛顿三大运动定律，它们描述的是气体和液体的运动在不同的环境里会如何演化。现在已经被广泛的用来模拟从海流、到飞机起飞后的湍流、再到流经心脏的血液流动等各个领域。

这些方程的历史可追溯到19世纪20年代：

欧拉建立了描述理想流体运动的微分方程，奠定了“白月光”故事的基调。

纳维在1761年提出了流体运动的粘度理论。

柯西在欧拉方程中引入流体微团的应力张量的概念，推导出了著名的柯西动量方程。

结合纳维对粘度的思考和柯西的张量思维，斯托克斯便大展神威，推出了引无数流体人尽折腰的“N-S方程”。

也就是**作为最普适的流体运动方程，它适用于可压缩变粘度的粘性流体的运动**。

当物理学家认为这些方程的可靠性就如实锤一样实时，数学家却对它们投以十分谨慎的目光。在数学家眼中，这些方程的运作似乎并不对。他们想要证明的是这些方程是真的可靠的：**无论是什么流体，也无论对其流动的预测发生在多远的未来，这些方程的数学仍保持正确**。而这种愿望已被证明是非常难以达到的。因此，三维空间中的N-S方程组的光滑解的存在性问题被美国克雷数学研究所设定为七个千禧年大奖难题之一。

光滑解要求的是最大化信息量，它们要求在与流体相关的向量场内， 每个点都存在一个向量。但如果我们放松这一要求，比如只需要能够计算某些点上的向量，或者只需对向量的计算进行估算呢？这样的解称为**“弱”解**。它们让数学家对一个方程的行为有个大致个把握，而不需要做找光滑解的所有工作。从某些角度来看，弱解比实际的解更容易描述，因为需要知道的信息更少。

弱解是以渐弱的状态出现的。如果将光滑解看作是一张有着无限精细的分辨率的流体数学图像，那么弱解就像是这张图片的32位、16位或8位版本，取决于你想要的微弱程度。

另外根据不同的研究场景，NS方程还可以做一些简化，比如我们更常用的不可压缩流动。

接下来我们就讲一下简化版的NS方程，以及求它的“弱”解的一些方法。

---

## 向量微分基础

在开始介绍NS方程之前，我们需要回顾一下几个比较重要的向量微分基础知识：Nabla算子、梯度、散度、旋度和拉普拉斯算子。

首先是Nabla算子，也被称为向量微分算子，一般读作"del"，它可以直接作用于函数，得到梯度，也可以与非标量函数作点积，得到散度，还可以与非标量函数作叉积，得到旋度。

梯度：函数u=f(x,y,z)的梯度定义为：偏f偏x，偏f偏y，偏f偏z所组成的一个三维向量，也就是相当于del f

关于梯度，有两个非常重要的性质：
第一个性质，可微函数沿梯度的方向导数最大，最大的方向导数是梯度的模。
第二个性质，梯度向量和f(x,y,z)的等值曲面是垂直的，也就是说梯度向量的法向量，所以我们可以通过求函数的梯度向量得到等值面的法向量。



下面我们来看散度的概念：散度的概念是针对于向量场的，对于向量场A=(P(x,y,z),Q(x,y,z),R(x,y,z))，如果分量函数P Q R，它的偏导数存在的话，我们称偏P偏x加上偏Q偏y加上偏R偏z是A在xyz这一点的散度；这就是向量场散度的概念。我们可以把它形式上地写成向量点乘的形式，也就是del与A做点乘。

那么散度的实际意义是什么呢？

散度实际上是向量场在点上的通量密度。

什么叫通量的密度呢？

对于空间中的一点M，以M为中心，r为半径作一个球，Σ_r是球面，求向量场通过Σ_r的通量，也就是向量场A沿曲面Σ_r的曲面积分除以Σ_r所围成的球体的体积，这表示单位体积通量

当r趋向于0的时候，所对应的比值极限，就是向量场A在M这一点的散度，所以散度它是向量场通量的密度。

如果这个向量场是个流速场的话，它表示的是在M这一点，流体流进或流出的强弱程度

如果散度大于0说明在这一点，它有流体流出，小于0说明它有流体流入。

如果散度=0，那我们把这个向量场称为是无源场。

这就是散度的概念，下面我们来看旋度



旋度，它同样也是针对向量场而言的。对于向量场A=(P(x,y,z),Q(x,y,z),R(x,y,z))，我们称这样的一个向量，由PQR关于xyz的偏导数所构成的一个三维向量，我们称它为向量场A的旋度。与散度一样，旋度我们也可以形式上的把它看成是两个向量运算的结果，我们可以把它看成偏x偏y偏z所构成的偏导数运算与PQR做叉乘以后的结果，因此A的旋度可以表示称del与A做叉乘的结果

下面我们来考虑旋度的实际意义：旋度的实际意义表示绕单位向量n的环流量的密度。

环流量密度怎么理解呢？

对于空间上的一点M，以及M出发的一个向量n，作一个以M为中心的一个圆，圆所在的平面与n垂直，而且圆的边界曲线Lr的方向与n的方向，满足右手法则

考虑向量场沿着曲线Lr的环流量，就是

向量场A沿曲线Lr的曲线积分除以Lr所围成面积，这个就是单位面积的环流量

当r趋向于0的时候，比值的极限，可以表示成，A在M这一点的旋度与n的点乘，这就是环流量的密度

从这个结论我们可以知道，向量场绕旋度的环流量密度最大

比如考虑，由流动的水所构成的流速场，怎么刻画环流密度的大小呢？把一个轮放在水中，由流动的水带动水轮转动，那么什么时候水轮转动的最快呢？

由上面的结论我们可以知道，当水轮的轴和A所对应的旋度是一致的时候，这个时候水轮是转动的最快的，因为这个时候它所对应的环流量的密度最大。

如果流速场是个无旋场的话，我们把水轮放在中间的任何位置，这个水轮都不会发生旋转



拉普拉斯算子，是空间中的二阶微分算子，定义为梯度的散度

作为散度，它表示梯度场的速度矢量的单位增加值，并且在点(x,y,z)周围的一个球面内都相同。所以拉普拉斯算子表示以某个点为中心的球面上的某个标量函数的平均值，在球面半径增大时增大的速率。

---

## 物质导数

物质导数，又被称为随体导数，当地导数+迁移导数

速度的物质导数表示流体微团的加速度

物质导数针对的是流体微团，而不是空间的固定点

这里所说的流体微团，指的是流动中的一个具有一定体积的无穷小流体微团，这里的无穷小的含义与微积分的无限小含义相同，而它必须足够大，达到包含了大量的流体分子，使得它可以被看成是连续介质。

DQ/Dt代表流体微团通过1点时，流体微团的物理量Q变化的瞬时时间变化率，称为物理量Q的物质导数。

注意DQ/Dt是给定的流体微团在空间运动时，其携带的物理量Q的时间变化率，它和∂Q/∂t不一样，后者是在固定点1处，物理量Q变化的时间变化率，对于∂Q/∂t我们需要将观察点固定于点1，考察由于流场瞬间的起伏导致的密度的变化

关于物质导数的物理意义，我们可以这么理解：

假设你在爬山，考虑你所感受到的气温，从时间方面来考虑，中午的温度比早上高；从空间方面来考虑，山脚的气温比山顶的气温高。当从拉格朗日视角来看时，你从一处爬到另一处，温度变化不仅由于你的位置的移动，也取决于时间的变化；而从欧拉视角来看，空间中的每一个点都是固定的，所以位置不会发生改变，但是时间会变化。这就是物质导数的物理意义。

---

## NS方程

有了这些基础知识以后，我们就可以开始着手推到NS方程了。

乍一看，这两条方程可能看起来很复杂！其实它们的理论基础我们在高中物理课上都学过。

接下来，我们就来一步一步将它们分解成让高中生也看得懂的几个部分。

## 动量方程

首先，我们来看动量方程：

动量方程其实遵循的是牛顿第二定律，也就是F=ma；我们都知道，F是流体粒子所受到的合力。

那么流体粒子受到的力有哪些呢?

最简单的就是像重力这样的体积力，体积力指的是穿越空间作用在所有流体元上的非接触力，体积力大小一般与流体元体积成正。

除了体积力以外，其他流体粒子也会对当前流体粒子产生作用力

流体内部的相互作用力之一便是压力，高压区会向低压区产生作用力。

这里我们只关注施加在粒子上的压力的净合力，也就是说，如果施加在粒子上压力在每个方向上都相等，那么它的压力的合力便为0。

我们用压力的负梯度-∇p （取负是因为方向是由压力大的区域指向压力小的区域）来衡量在当前流体粒子处压力的不平衡性，那么，流体粒子所受到的压力就是对-∇p在整个流体粒子的体积上进行积分，为了简化，这里直接乘上V，得到-∇p Vg ⃗

黏力：

除了压力，流体粒子之间的相互作用还会产生黏力，我们直观地把这种力理解为尽可能使得粒子以周围区域的平均速度移动的力，也就是使得粒子的速度与周围区域粒子速度的差距最小化。

前面我们提到过，拉普拉斯算子是衡量一个量与之周围区域该量平均值之差的算符，因此，我们可以用当前粒子速度矢量与周围区域平均速度矢量之差∇∙∇u ⃗来衡量黏力，为了计算黏力，我们需要对

∇∙∇u ⃗在整个粒子的体积上进行积分，跟前面求压力类似，为了简化，我们直接乘上体积V，得到V∇∙∇u ⃗，另外，这里还引进一个称为动力粘度系数的物理量μ

这样就得到了我们的动量方程

在拉格朗日视角和欧拉视角中，分别有不同形式的N-S方程（或者叫动量方程），拉格朗日视角中是这样的，而欧拉视角中是这样的：

为什么在拉格朗日方法中使用物质导数，而欧拉法中使用偏导数呢？这里就涉及到我们前面提到的物质导数的物理意义了。
 (Du ⃗)/Dt是流体关于速度场的物质导数

在基于粒子的流体模拟中，每个粒子的加速度就是关于速度的物质导数(Du ⃗)/Dt，这是因为物质导数的定义就是从拉格朗日视角展开的，所以基于粒子的模拟不需要对流项。

拉格朗日视角下的物质导数可以转换成欧拉视角下的一个形式,

就是(∂u ⃗)/∂t+(u ⃗∙∇)u ⃗，这是因为欧拉视角下我们关注的是空间中的一个固定点，因而物质导数就变成了给定点上的速度随时间的变化率(∂u ⃗)/∂t与在流体先前的速度场作用下的变化率(u ⃗∙∇)u ⃗之和。

因此，在基于欧拉网格的流体模拟方法中，我们需要计算固定点上的加速度(∂u ⃗)/∂t，将(u ⃗∙∇)u ⃗移至右边，用split的思想去一项一项的解方程。



## 质量守恒方程

接下来，我们来看另一条方程：质量守恒方程

关于流体的压缩性在此不做过多的物理细节描述，只需知道一点：通常情况下流体的体积变化非常小（除开一些极端的情况，而且这些极端情况我们日常生活中较少出现）。可压缩流体的模拟涉及到非常复杂的情况，往往需要昂贵的计算资源开销，为此在计算机流体模拟中我们通常把所有的流体当作是不可压缩的，即它们的体积不会发生变化。

通过围绕边界曲面S对流体速度V在曲面法线方向上的分量进行积分来衡量这块部分流体的体积变化速率

速度场无散度表明该速度场中流体体积既不膨胀也不坍缩，而是保持在一个常量



---

## NS方程的求解

为了简化求解的方程，我们把黏力项去掉，得到的就是无黏流欧拉方程。

前面提到过NS方程的解就是随时间变化的流速场，也就是要求空间中的v

下面我们来看一下基于欧拉视角的求解

---

这个方法主要是用split的思想去一项一项的解常微分方程，就是说我们把一条复杂的方程分解成它的组成部分来单独求解。

举个简单的例子就是，对于dq/dt=f(q)+g(q)这个常微分方程，我们可以分成2步

第一步是先对dq/dt = f(q)做前向欧拉得到一个临时的q，然后第二步对dq/dt=q+g(q)做前向欧拉得到最终的q

我们可以证明用split的思想，求得的解能满足二阶精度的误差。

---

接下来我们就根据刚刚这个分步思想对NS方程进行拆解

忽略黏力之后，动量方程和质量守恒方程就可以拆解成这3组方程，它们分别对应于对流项，体积力项，压力投影或者说是不可压缩投影项。

那么整个模拟过程就可以总结成右边这个流程图：

首先初始化一个无散度的速度场；接着在每个时间步长的迭代中，按照计算对流项，计算体积力项，计算无散度投影这几个顺序不断地更新速度场。

---















---

PBD

1. 基于力的动力学：
   物理思想是：任何物体都可以用约束连接的一组粒子来表示，然后就可以用约束投影来代替传统的求力和数值积分的操作
   TODO：愤怒的小鸟碰撞图
2. 
3. 



---

待解决问题：

内力和外力的区分：是基于单个粒子还是整个系统

