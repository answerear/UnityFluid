# `流体模拟入门分享`



---



[TOC]



---

## 认识流体

首先，在开始研究流体之前，我们得先对它有一个初步的认识。也就是，我们得先搞懂什么是流体。

```
液体和气体的统称
易于流动的物质
```

我们一般认为，流体是液体和气体之类的**易于流动的物质**，它是区别于固体的物质。
但这个定义不太明确，什么样才是**易于流动**呢？

所以，要正确理解流体和固体的区别，首先要理解**什么是流动**。

```
不断变形的运动
```

流动是指**不断变形的运动**，这里变形指的是**物体的形状发生了变化**。

右边这张图就展示了一个物体在不同的力的作用下发生各种不一样的变形的情况。

<img src="ppt image/1_认识流体_变形.png" alt="1_认识流体_变形" style="zoom:30%;" />

```
受力时的运动状态
```

<img src="ppt image/1_认识流体_压力.png" alt="1_认识流体_压力" style="zoom:30%;" />

水装在矿泉水瓶里的时候，我们是不能判断它是液体还是固体的，当我们把它倒出来的时候，能流出来的是水，流不出来的是冰。也就是说，判断一种物质是不是流体，不是从它的成分判断的，而是根据它**受力时的运动状态**。



<img src="ppt image/1_认识流体_剪切力.png" alt="1_认识流体_剪切力" style="zoom:30%;" />

另外，固体可以放在桌子上保持静止，而流体就必须装在容器中才行。原因是只有装在容器中，才能使流体不受**剪切力**作用。流体的内部只要存在剪切力，就不可能处于静止状态，而是会**不断地发生变形运动**，也就是流动。

所以，我们可以给流体下一个严格的定义：**在任意小的剪切力作用下，都会发生连续不断的变形的物质**。

---

## 观察流体——两种不同的视角

在对流体有了初步的认识之后，我们就可以对流体运动进行观察和研究了。

```
欧拉视角
拉格朗日视角
```

对流体的观察，一般分为欧拉和拉格朗日两种视角。

```
固定位置
流体流过时测量
```

其中，欧拉视角是在固定的位置下，观察流体流过对应位置时的物理量；

```
运动的粒子
粒子携带物理量
```

而拉格朗日视角则是将流体视为流动的单元，例如将一片羽毛放入风中，那么羽毛的轨迹可以帮我们指示空气的流动规律。

```
岿然不动 和 随波逐流
```

所以，对于欧拉视角，你可以自己是岿然不动的，你就蹲在那里，每时每刻问自己一个问题，对于我自己这个位置，经过的材料的速度是多少？而对于拉格朗日视角，你可以把自己想象成是一条随波逐流的小船，你每时每刻在问自己另外的问题，我的位置在哪里以及我现在的速度是多少，也就是说你是随着你模拟的材料一起移动。

<img src="ppt image/2_观察流体.png" alt="2_观察流体" style="zoom:30%;" />

这两张图中，左边就是一个典型的欧拉表示的烟雾模拟，而右边展示的是则基于拉格朗日视角的模拟，也是我们前面开场动画里的展示的基于位置的动力学的模拟，可以看到，它其实就是采用各种各样的粒子，然后通过各种方式给物体连接起来；然后这个粒子可以表示降落伞的绳子，这个降落伞下面栓的是个兔子，我们不仅可以用这个粒子来模拟水，还可以用它来模拟各种各样的东西；

~~对于左边这个基于欧拉的模拟，一般是用一个背景的网格，然后网格上的每一个点表示的是穿过这个点的流体的速度。
		而右边这个基于粒子的模拟，它的每一个粒子表示的是这个粒子它会携带什么？一般会携带它自己的速度和位置。
所以一个常见的问题就是，欧拉的网格里面的每个点，我们是不记它的位置的，因为它的位置很容易算出来，对吧？因为你可以通过它的 i，j，k下标，然后乘上一个 delta x，你就知道这个网格的格点的位置是在什么地方，但是拉格朗日粒子里面，我们会在粒子上面额外的记一个位置，因为这个粒子的位置会随着被模拟的介质的状态被不断地移动。~~

总的来说，欧拉和拉格朗日两个视角只是从不同观点出发，研究同一个运动。

---

## 流体力学的“白月光”——NS方程

NS方程也就是纳维-斯托克斯方程，可以说是流体力学界的“白月光”。它在流体力学领域的地位相当于牛顿三大运动定律在经典力学里的地位。它们描述的是气体和液体在不同的环境里的运动规律，目前被广泛的用于模拟海流、飞机起飞后的湍流、以及血液流动等。

这些方程的历史可追溯到几百年前：
		首先是欧拉建立了描述理想流体运动的微分方程，奠定了“白月光”故事的基调。
		后来，纳维在1761年提出了流体运动的粘度理论。
		然后，柯西在欧拉方程中引入流体微团的应力张量的概念，推导出了著名的柯西动量方程。
		最后，结合纳维对粘度的思考和柯西的张量思维，斯托克斯便大展神威，推出了引无数流体人尽折腰的“N-S方程”。
		也就是**作为最普适的流体运动方程，它适用于可压缩变粘度的粘性流体的运动**。

当物理学家认为这些方程的可靠性就如实锤一样实时，数学家却对它们投以十分谨慎的目光。在数学家眼中，这些方程的运作似乎并不对。他们想要证明的是这些方程是真的可靠的：**无论是什么流体，也无论对其流动的预测发生在多远的未来，这些方程的数学仍保持正确**。而这种愿望已被证明是非常难以达到的。因此，三维空间中的N-S方程组的光滑解的存在性问题被美国克雷数学研究所设定为七个千禧年大奖难题之一。

光滑解要求的是最大化信息量，它们要求在与流体相关的向量场内， 每个点都存在一个向量。但如果我们放松这一要求，比如只需要能够计算某些点上的向量，或者只需对向量的计算进行估算呢？这样的解称为**“弱”解**。它们让数学家对一个方程的行为有个大致个把握，而不需要做找光滑解的所有工作。从某些角度来看，弱解比实际的解更容易描述，因为需要知道的信息更少。

弱解是以渐弱的状态出现的。如果将光滑解看作是一张有着无限精细的分辨率的流体数学图像，那么弱解就像是这张图片的32位、16位或8位版本，取决于你想要的微弱程度。

另外根据不同的研究场景，NS方程还可以做一些简化，比如我们更常用的不可压缩流动。

这一张就是一张用“弱”解去预测的风场的演变图。

接下来我们就讲一下简化版的NS方程，以及求它的“弱”解的一些方法。

---

## 向量微分基础

在开始介绍NS方程之前，我们需要回顾一下几个比较重要的向量微分基础知识：Nabla算子、梯度、散度、旋度和拉普拉斯算子。

### Nabla算子

首先是Nabla算子，也被称为向量微分算子，一般读作"del"，它可以直接作用于函数，得到梯度，也可以与非标量函数作点积，得到散度，还可以与非标量函数作叉积，得到旋度。

### 梯度

接下来我们来讲梯度
		梯度：函数u=f(x,y,z)的梯度定义为：偏f偏x，偏f偏y，偏f偏z所组成的一个三维向量，应用我们前面提到的nabla算子，也就是相当于del f
		关于梯度，有两个非常重要的性质：
		第一个性质，可微函数沿梯度的方向导数最大，最大的方向导数是梯度的模。
		第二个性质，梯度向量和f(x,y,z)的等值曲面是垂直的，也就是我们可以通过求函数的梯度向量得到等值面的法向量。

### 散度

下面我们来看散度的概念：散度的概念是针对于向量场而言的，对于向量场A=(P(x,y,z),Q(x,y,z),R(x,y,z))，如果分量函数P Q R，它的偏导数存在的话，我们称偏P偏x加上偏Q偏y加上偏R偏z是A在xyz这一点的散度；这就是向量场散度的概念。我们可以把它形式上地写成向量点乘的形式，也就是del与A做点乘。
		那么散度的实际意义是什么呢？
		散度，它实际上是向量场在点上的通量密度。
		什么叫通量的密度呢？
		对于空间中的一点M，我们以M为中心，r为半径作一个球，Σ_r是球面，现在我们来求向量场通过Σ_r的通量，也就是向量场A沿曲面Σ_r的曲面积分，接下来，我们用它除以Σ_r所围成的球体的体积，就得到了单位体积通量
		当r趋向于0的时候，所对应的比值极限，就是向量场A在M这一点的散度，所以散度它是向量场通量的密度。	

如果这个向量场是个流速场的话，它表示的是在M这一点，流体流进或流出的强弱程度

如果散度大于0说明在这一点，它有流体流出，小于0说明它有流体流入。如果散度=0，那我们把这个向量场称为是无源场。

关于散度，我们还有一个非常重要的定理，也就是大家在大学物理中学过的高斯定理：具体的证明我们就不证了，我们只要记住它的结论就好，简单来说，就是对于向量场在封闭曲面的面积分等于它的散度在这个曲面所围起来的体积上的体积分。这个定理非常重要，我们在后面讲到不可压缩流的时候也会用得到。

### 旋度

讲完散度的概念，下面我们来看旋度
		旋度，它同样也是针对向量场而言的。对于向量场A=(P(x,y,z),Q(x,y,z),R(x,y,z))，我们称这样的一个向量，由PQR关于xyz的偏导数所构成的一个三维向量，我们称它为向量场A的旋度。与散度一样，旋度我们也可以形式上的把它看成是两个向量运算的结果，我们可以把它看成偏x偏y偏z所构成的偏导数运算与PQR做叉乘以后的结果，因此A的旋度可以表示称del与A做叉乘的结果

下面我们来考虑旋度的实际意义：旋度的实际意义表示绕单位向量n的环流量的密度。
		那么环流量密度怎么理解呢？
		对于空间上的一点M，以及M出发的一个向量n，作一个以M为中心r 为半径的一个圆，圆所在的平面与n垂直，而且圆的边界曲线Lr的方向与n的方向，满足右手法则
		考虑向量场沿着曲线Lr的环流量，就是
		向量场A沿曲线Lr的曲线积分除以Lr所围成面积$\pi r^2$，这个就是单位面积的环流量
		当r趋向于0的时候，比值的极限可以表示成，A在M这一点的旋度与n的点乘，这就是环流量的密度

从这个结论我们可以知道，向量场绕旋度的环流量密度最大
		比如我们考虑，由流动的水所构成的流速场，怎么刻画环流密度的大小呢？把一个轮放在水中，由流动的水带动水轮转动，那么什么时候水轮转动的最快呢？
		由上面的结论我们可以知道，当水轮的轴和A所对应的旋度是一致的时候，这个时候水轮是转动的最快的，因为这个时候它所对应的环流量的密度最大。
		如果流速场是个无旋场的话，我们把水轮放在中间的任何位置，这个水轮都不会发生旋转

### 拉普拉斯算子

拉普拉斯算子，大家估计一点都不陌生了，像图像处理之类的很多领域都用到的。
		拉普拉斯算子，是空间中的二阶微分算子，定义为梯度的散度
		作为散度，它表示梯度场的速度矢量的单位增加值，并且在点(x,y,z)周围的一个球面内都相同。所以拉普拉斯算子表示以某个点为中心的球面上的某个标量函数的平均值，在球面半径增大时增大的速率。通俗一点讲，可以认为它是用来评价某个位置的物理量跟它周围的平均物理量之间的差别的一个算子。

---

## 物质导数

除了前面提到的那些向量微分算子，流体力学中还有一个非常重要的概念，就是物质导数。
		物质导数，有些书上会把它叫做随体导数，其实实际上它们就是同一个东西。

速度的物质导数表示流体微团的加速度

首先，物质导数针对的是流体微团，而不是空间的固定点，这里所说的流体微团，指的是流动中的一个具有一定体积的无穷小流体微团，这里的无穷小的含义与微积分的无限小含义相同，而它必须足够大，大到包含了大量的流体分子，使得它可以被看成是连续介质。
		当用到物质导数时，一般会用大写的D来表示，这里，DQ/Dt代表流体微团通过1这个位置时，它的物理量Q变化的瞬时时间变化率，我们把这个瞬时时间变化率称为物理量Q的物质导数。

注意DQ/Dt是给定的流体微团在空间运动时，其携带的物理量Q的时间变化率，它和∂Q/∂t不一样，后者是在固定点1处，物理量Q变化的时间变化率，所以∂Q/∂t又被称为当地导数，而 xxx 则被称为迁移导数，它在物理上表示由于流体微团从流场中的一点运动到另一点，流场的空间不均匀性而引起的时间变化率。

关于物质导数的物理意义，我们可以这么理解：			

假设你在爬山，考虑你所感受到的气温，从时间方面来考虑，中午的温度比早上高；从空间方面来考虑，山脚的气温比山顶的气温高。当从拉格朗日视角来看时，你从一处爬到另一处，温度变化不仅由于你的位置的移动，也取决于时间的变化；而从欧拉视角来看，空间中的每一个点都是固定的，所以位置不会发生改变，但是时间会变化。这就是物质导数的物理意义。

我们再来看一下物质导数和对时间的全导数的关系，其实物质导数不过就是对时间的全导数，只是前面这一条式子更能凸显物质导数的物理意义，而后面这条式子在数学上更正式一些而已。



---

## NS方程

有了这些基础知识以后，我们就可以开始着手推导NS方程了。

乍一看，这两条方程可能看起来很复杂！其实它们的理论基础我们在高中物理课上都学过。

严格来说，第二条方程其实是属于不可压缩流的一个条件，它不属于普适的NS方程，只是我们在做流体模拟的时候，一般都把流体当做是不可压缩来做的，所以这里也提前把它放出来。

接下来，我们就来看看这两条方程是怎么来的。

## 动量方程

首先，我们来看动量方程：

动量方程其实是从拉格朗日视角出发来推导的，她遵循的是牛顿第二定律，也就是F=ma；这里F代表的是流体粒子所受到的合力。既然是合力，那么我们就要分析单个流体粒子会受到的外力和内力了。

那么流体粒子受到的力有哪些呢?

最简单的就是像重力这样的体积力，体积力指的是穿越空间作用在所有流体元上的非接触力，体积力的大小一般与流体元体积成正。

除了体积力以外，其他流体粒子也会对当前流体粒子产生作用力，这些作用力一般有压力，黏力，摩擦力等等。

先来看压力，一般高压区会向低压区产生作用力。
		这里我们只关注施加在粒子上的压力的净合力，也就是说，如果施加在粒子上压力在每个方向上都相等，那么它的压力的合力便为0。
		我们用压力的负梯度-∇p （取负是因为方向是由压力大的区域指向压力小的区域）来衡量在当前流体粒子处压力的不平衡性，那么，流体粒子所受到的压力就是对-∇p在整个流体粒子的体积上进行积分，为了简化，这里直接乘上V，得到$-\nabla p V$
		除了压力，流体粒子之间的相互作用还会产生黏力，我们可以直观地把这种力理解为尽可能使得粒子以周围区域的平均速度移动的力，也就是使得粒子的速度与周围区域粒子速度的差距最小化。
	前面我们提到过，拉普拉斯算子是衡量一个量与之周围区域该量平均值之差的算符，因此，我们可以用当前粒子速度矢量与周围区域平均速度矢量之差$\nabla \cdot \nabla \vec{u}$来衡量黏力，为了计算黏力，我们需要对$\nabla \cdot \nabla \vec{u}$在整个粒子的体积上进行积分，跟前面求压力类似，为了简化，我们直接乘上体积V，得到$V \nabla \cdot \nabla \vec{u}$，另外，这里还引进一个称为动力粘度系数的物理量μ

这样就得到了我们的动量方程了。

在拉格朗日视角和欧拉视角中，分别有不同形式的N-S方程（或者叫动量方程），拉格朗日视角中是这样的，而欧拉视角中是这样的：

为什么在拉格朗日方法中使用物质导数，而欧拉法中使用偏导数呢？这里就涉及到我们前面提到的物质导数的物理意义了。我们前面对粒子的受力分析是基于拉格朗日视角分析的，所以这里不需要对流项。另外，我们前面提到过物质导数的定义也是从拉格朗日视角展开的。
~~基于粒子的流体模拟中，每个粒子的加速度就是关于速度的物质导数$D\vec{u}/Dt$，这是因为物质导数的定义就是从拉格朗日视角展开的，所以基于粒子的模拟不需要对流项。~~

拉格朗日视角下的物质导数可以转换成欧拉视角下的一个形式,

就是$\partial \vec{u}/\partial t+\vec{u} \nabla \cdot \vec{u}$，这是因为欧拉视角下我们关注的是空间中的一个固定点，因而物质导数就变成了给定点上的速度随时间的变化率$\partial \vec{u}/\partial t$与在流体先前的速度场作用下的变化率$\vec{u} \nabla \cdot \vec{u}$之和，也就是我们前面说的当地导数和迁移导数两部分之和。

### 质量守恒方程

接下来，我们来看另一条方程：质量守恒方程

关于流体的压缩性我们就不做过多的物理细节描述了，这里我们只需知道一点：通常情况下流体的体积变化非常小（除开一些极端的情况，而且这些极端情况我们日常生活中较少出现）。可压缩流体的模拟涉及到非常复杂的情况，往往需要昂贵的计算资源开销，为此在计算机流体模拟中我们通常把所有的流体当作是不可压缩的，即它们的体积不会发生变化。

通过围绕边界曲面S对流体速度V在曲面法线方向上的分量进行积分来衡量这块部分流体的体积变化速率，这里我们利用高斯散度定理得到 xxxxx

因为不可压缩，所以体积变化率为0，也就是这个积分的值等于0，那明显体积是不可能为0的，所以只能是被积分项等于0，也就是速度的散度为0.

速度场无散度表明该速度场中任意一点上都是，有进必有出的

---

## NS方程的求解

现在我们已经知道NS方程是什么了，也知道了它的解就是随时间变化的流速场，也就是要求空间中的v

那么接下来我们就要去求解它了，那我们还是分别基于欧拉和拉格朗日两个视角来求解NS方程，然后对这两种方法进行一个比较。

为了简化求解的方程，我们把黏力项去掉，得到的就是无黏流欧拉方程。
		前面提到过NS方程的解就是随时间变化的流速场，也就是要求空间中的v

下面我们来看一下基于欧拉视角的求解。

### 欧拉网格法求解NS方程——离散化

在开始求解前，我们要先确定从连续的物理世界到离散的计算机世界的数据

在流体模拟中，我们一般采用一种叫MAC的网格来表示；许多不可压缩流体模拟的算法都在这个网格结构上呈现出了良好的效率。

MAC网格是一种交叉排列的网格，它的特点就是：不同类型的物理量存储于网格的不同位置。

以右边这张二维的MAC网格为例，为了便于理解，我们后面都用二维的网格来讲解，三维的直接类比就可以了。从这张图中，我们可以看到，流体粒子的压力数据存储于网格的中心点，而速度则沿着笛卡尔坐标被分成了两部分

有了这个网格表示之后，我们就可以根据中心差分法来估算某个网格点上的速度了。

---

### 欧拉网格法求解NS方程——分步求解思想

确定了数据的存储结构之后，我们就可以开始着手方程的求解了。

我们把NS方程的对流项挪到右边，可以看到，其实这个就是常微分方程，而且是一条复杂的常微分方程，可以看到右边的项很多，即便是忽略黏力把它变成欧拉方程，右边也还剩3个比较复杂的项。那可不可以先把简单的处理了，然后最后再处理复杂的？如果可以，那它的精度误差是多少？

这个方法主要是用split的思想去一项一项的解常微分方程，就是说我们把一条复杂的方程分解成它的组成部分来单独求解。
		举个简单的例子就是，对于dq/dt=f(q)+g(q)这个常微分方程，我们可以分成2步
		第一步是先对dq/dt = f(q)做前向欧拉得到一个临时的q，然后第二步对dq/dt=q+g(q)做前向欧拉得到最终的q

这里，我们可以证明用split的思想，求得的解能满足二阶精度的误差。

---

接下来我们就根据刚刚这个分步思想对NS方程进行拆解

忽略黏力之后，动量方程和质量守恒方程就可以拆解成这3组方程，它们分别对应于对流项，体积力项，压力投影或者说是不可压缩投影项。

那么整个模拟过程就可以总结成右边这个流程图：
		首先初始化一个无散度的速度场；接着在每个时间步长的迭代中，按照计算对流项，计算体积力项，计算无散度投影这几个顺序不断地更新速度场。

### 欧拉网格法求解NS方程——对流

我们先来看看对流，这里的对流法，也被称为是半拉格朗日对流法，为什么是半呢？前面说过，我们是基于欧拉的网格法来求解的，但是在做对流这一步的时候，我们用到了拉格朗日视角的相关知识，所以这里被称为半拉格朗日对流。

在基于粒子的流体模拟中，对流项被自动地执行，即不需要对粒子进行对流。

对流本质上就是在流体的速度场作用下，不同网格点之间传递流体微团。

从拉格朗日视角来看，就是流体微团在速度场的作用下在空间中移动，流体微团的一些性质（如流体微团的密度）在移动的过程中保持不变。

求点G在第n+1个时间步时的物理q_G^(n+1)
		在拉格朗日的视角下，我们可以寻找在第n+1时间步之前，是空间中的哪一个点上的流体粒子在速度场u ⃗的作用下“流向”了点G

那么问题就转化成，怎么找出这个点P？
		很简单，我们直接根据位移除以时间等于速度，将x g， x p， delta t还有速度代入方程，就可以算出x P了。

这就是对流项的求解过程。

---

### 欧拉网格法求解NS方程——流体的不可压缩投影

在流体模拟中，确保流体的不可压缩性是非常重要、关键的一步，也是最耗时的一步，这是整个流体模拟过程中的核心，涉及到模拟效果的真实性、模拟过程的效率快慢两方面的内容，因而相关的数学内容比较多。

我们希望最终算出的速度u ⃗^(n+1) 是无散度的。
		要找到满足这一目标的压力，我们需要将压力更新公式代入无散度公式
		首先我们来看压力梯度的离散化，压力值存储在MAC网格的中间点上，所以可以得到i,j这一点上的压力梯度等于xxxxxx
		然后我们来看速度散度的离散化，采用中心差分法计算离散的散度，得到xxxxx

接下来就是最关键的一步了，再看回我们的压力/不可压缩投影方程，我们把速度和压力代入，求出在i，j这一点的速度散度，最后整理一下，就得到了关于压力的方程了。
		左边是关于压力的拉普拉斯算子的数值近似，右边是关于速度场散度的数值近似，我们最终要求解的就是这么一个关于压力的方程。
		这其实是一个泊松方程。

---

前面讨论的仅仅是一个格子的压力项求解方程，事实上我们要求解的是整个流体区域的压力项值。为此，为了便于阐述和求解，我们将上面的线性方程写成矩阵乘向量的形式。

A: 方程中所有压力项的系数（大规模的稀疏矩阵，大部分的矩阵元素都为0）
		P: 所有流体区域的压力项写成一个未知变量的向量
		B:所有流体区域的负散度组成的向量

我们来看一下复杂度，空间复杂度是O m平方乘以n平方，可以说是相当可怕了，而且这只是二维的情况，三维就更大了。

求矩阵的逆是个非常昂贵的操作，在矩阵比较小的时候，你求逆还可以求求，这个就比较省事，但是如果说矩阵非常大的话，你求这个逆矩阵，很多时候矩阵都存不下。可能有人会说这个矩阵A是个很稀疏的矩阵，没错，A的元素绝大多数都是0，虽然这个 A 是个稀疏矩阵，但是它的逆不一定是个稀疏矩阵，它的逆可能变成一个稠密矩阵，那你的内存可能就存不下了。
		所以这里不大可能去求逆的，一般会用一些直接一点的解法：例如共轭梯度法之类的，这个就是纯数学的方法了，我们就不作展开了。

到这里，我们就介绍完整个一个基于欧拉视角的流体模拟的过程了

---

### 拉格朗日粒子法求解NS方程——SPH

前面我们介绍了基于欧拉视角的流体模拟的过程；接下来我们讲一讲基于拉格朗日视角解流体力学的一个方法，Smoothed particle Hydrodynamics，一般称为 SPH。

粒子法的思想是将流体或固体物质材料本身离散成若干单元（也可以称为点或者粒子，如何称呼不重要），每个粒子代表了一小团流体或固体，是一种宏观的近似。在拉格朗日体系下，离散后的材料粒子满足牛顿第二运动定律，计算出粒子运动速度后，即可以获得粒子在空间中的运动位置。流体粒子的受力，除了体积力和粘性力等，最重要的是压力梯度项。粒子法的一个关键难点是求解压力场。

SPH本质上是一种核密度估计（Kernel Density Estimation，KDE）。把空间中的物理量用它周围一个范围内的相同物理量通过逼近Delta函数的核函数来进行插值。

SPH一开始是用来求天体物理的。它有什么好处呢？
它有一个最大的好处就是不需要 mesh，非常适合用来模拟自由表面的流体。什么叫自由表面的流体呢？比如说你有一盆水，然后这个水有一个水和 空气之间的界面，那什么不是自由表面的流体呢，比说烟雾就不是自由表面的流体了。

SPH 有个很大的好处就是，直观上非常容易理解，你可以理解成每个粒子是一小陀水，另外，作为粒子法，它还有一个更大的好处就是，天然支持并行。

这个 SPH 的高层的思想是什么呢？
就是我们用一坨粒子，然后每个粒子携带一些物理量，然后用一个核函数去近似一个连续的场，然后这边这个公式其实它也非常直观，就是说在 x 这一点，它的这个物理这个场的值等于什么呢？我去给周围求个和，然后求和的时候，我用这个核函数去加权平均它周围的粒子，这里严格来说并不是一个加权平均，只是直观来说，它其实就是做了一个类似于Smoothing 的，把它周围的粒子给光滑了一下。

这个核函数实际上是一个中间大，两边小的函数，所以它可以让接近这个点 x 的粒子贡献更多，然后远离这个点的粒子贡献更小，当你的粒子特别远，超过一定的范围，比如说超过这个核函数的半径以后，贡献就是 0 了。

那么这个地方，A可以是几乎任何随着空间变化的物理量，比如说可以是速度，密度，压力

前面提到了，我们可以用这个 A(x)的公式来去在每一个粒子处计算出这个粒子所在的这个位置的物理量的值是多少，对吧？
很多时候我们需要算它的梯度，那么梯度怎么办呢？例如我们公式里面压强的梯度；这里可以直接取核函数的梯度来近似，除了梯度，我们可能还需要算它的拉普拉斯算子，同样的，直接取核函数的拉普拉斯算子来近似。

事实上，在实现SPH的时候，梯度和拉普拉斯算子都不用这两条公式，具体为什么我们在后面介绍。

---

下面我们来看SPH求解NS方程的具体步骤：

前面说过了，基于拉格朗日视角的NS方程，没有对流

为了方便后面的计算，对方程的左右两边同时乘以密度\rho，所以右边其实就是力除以体积，这里需要强调一下，我们用大F表示力，用小f表示F/V

根据前面提到的核函数的性质，SPH的求解需要加上一个邻域搜索的步骤，也就是先确定每个粒子的邻居之后，才能做后面的密度，体积力，黏力和压力的计算，其中体积力，黏力和压力这3项可以同时计算。

下面我们先看密度的计算方法。

其实就是直接套入前面的通用物理量的计算公式，把\rho 代入公式，化简后，可以发现，粒子i的密度其实就是由邻居粒子的质量加权求和得到。

有了密度以后，我们就可以估算压力了。
这里借鉴了理想气体状态方程：p=k\rho，然后改成p_i = k(\rho_i - \rho_0)，其中k是刚度参数，\rho_0代表静止密度，对于水来说是1000
这个公式指的是，压力与密度差成正比。

所以根据前面的核密度公式，我们代入可以求得压力=balabala；再次强调一下这里的小f是压力除以体积

现在，我们来看两个相邻的粒子，如果p_1不等于p_2，那么就会有F ⃗_1^pressure不等于F ⃗_2^pressure，违反了牛顿第三定律，同时也会使得整个系统的动量不守恒，所以这里需要做一点修改，改成balabala，这么改了以后，其实就不是真正的梯度了，但是它能保持力的对称性，还有保持动量守恒，这里的梯度可以说算是SPH的一个不太优雅的地方。

类似的，黏力也需要满足力的对称性，这里需要强调一下，黏力不依赖于绝对速度，而只依赖于速度差，也就是相对速度，所以最后我们的黏力表示成balabala

体积力的计算很简单，直接乘上就好

所以最后，我们的粒子位置更新就是：

先求合力，然后求加速度，接着算出速度，最后通过速度和步长算出最终的位置。

这就是整个SPH算法的伪代码了：



---

关于SPH，还有3个需要说明一下的地方
首先是核函数的选取，核函数的选取对整个模拟的稳定性、准确性以及运行速度都会有影响。一般用得比较多的是Poly6和spiky。balabala

第二个需要说明的就是邻域搜索，这部分是整个算法力最耗性能的部分，求一个粒子的邻域，最简单粗暴的方法就是暴力搜索，每一个时间步的时间复杂度O N 平方，n 是粒子数目，实际上我们可能有100w 个粒子，甚至 1000w个粒子，n 平方的复杂度是绝对不能接受的。显然这里存在很大的加速空间，例如我们可以利用空间数据结构，把时间复杂度降到 O(n) 
就是对于每一个粒子，如果说我们能精确找到跟它距离不超过 h 的所有粒子，那么我们就不需要 loop over 所有的其他粒子了。

最后一个需要说明的就是在边界附近的流体粒子的密度计算问题。

密度是sph模拟所必须的一个场量，用于计算压力和黏滞力。只有周围充满粒子的情况下才能被正确的估计，边界上的密度估计值存在较大误差。为了减少这种误差，计算液体粒子的密度和力时，附近的**边界粒子**也被考虑在内。

 学者Akinci在2012提出了一种用于不可压缩 SPH 的多功能刚性流体耦合方法，论文主要考虑不可形变刚体的交互，对于刚体，作者用其表面粒子来表示。

刚体上每一个边界粒子 ![[公式]](https://www.zhihu.com/equation?tex=b_%7Bi%7D) 代表一个体积:	balabala	

因此流体密度可以写为：balabala	

考虑边界粒子体积大小对液体密度的影响

最终，修正后的液体密度

边界-液体之间压力计算

在SPH中，两个液体粒子之间压力可以直接推导得：

对于不可压缩流体

对于weakly compressible液体来说， ![[公式]](https://www.zhihu.com/equation?tex=%5Crho_%7Bi%7D%5Capprox%5Crho_%7Bj%7D) ,同时 ![[公式]](https://www.zhihu.com/equation?tex=p_%7Bi%7D%5Capprox+p_%7Bj%7D) ,因此，式（7）可以近似为：

边界粒子 ![[公式]](https://www.zhihu.com/equation?tex=b_%7Bj%7D) 对液体粒子 ![[公式]](https://www.zhihu.com/equation?tex=f_%7Bi%7D) 的压力：

对应的，液体粒子对边界粒子的压力：

SPH 里有一套理论，这个理论就是，它的梯度是这么算的，你仔细去推呢，它的值也不是特别准确，但是呢它可以保证在 SPH 里它是对称的，对称的可以保证什么呢？可以保证它是动量守恒的。
如果不用这个公式去算，就会出现各种各样的不稳定。
求梯度和求拉普拉斯的算法应该算是 SPH 里不特别优雅的地方。



---

SPH 有很多很多的变种：
PCISPH
PBF

SPH 的加速

每一个时间步的时间复杂度O N 平方，n 是粒子数目
实际上可能有100w 个粒子，甚至 1000w，n 平方就不能接受了


空间数据结构，降到 O n
就是对于每一个粒子，如果说我们能精确找到跟它距离不超过 h 的所有粒子，那么我们就不需要 loop over 所有的其他粒子了


SPH 有个好处就是，它可以比较好的模拟各种介质的耦合
流体，弹性物体，刚体都可以



---


